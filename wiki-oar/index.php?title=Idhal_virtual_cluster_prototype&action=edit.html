<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="Content-Style-Type" content="text/css" />
		<meta name="generator" content="MediaWiki 1.15.5-2squeeze6" />
		<meta name="robots" content="noindex,nofollow" />
		<meta name="keywords" content="Idhal virtual cluster prototype,Administrators,Users" />
		<link rel="next" href="index.php/Idhal_virtual_cluster_prototype.html" />
		<link rel="shortcut icon" href="http://oar.imag.fr/images/logo_oar.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="WikiOAR (en)" />
		<link rel="alternate" type="application/rss+xml" title="WikiOAR RSS feed" href="index.php%3Ftitle=Special:RecentChanges&amp;feed=rss" />
		<link rel="alternate" type="application/atom+xml" title="WikiOAR Atom feed" href="index.php%3Ftitle=Special:RecentChanges&amp;feed=atom" />
		<title>View source - WikiOAR</title>
		<link rel="stylesheet" href="skins/common/shared.css%3F207.css" type="text/css" media="screen" />
		<link rel="stylesheet" href="skins/common/commonPrint.css%3F207.css" type="text/css" media="print" />
		<link rel="stylesheet" href="skins/monobook/main.css%3F207.css" type="text/css" media="screen" />
		<!--[if lt IE 5.5000]><link rel="stylesheet" href="/skins/monobook/IE50Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 5.5000]><link rel="stylesheet" href="/skins/monobook/IE55Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 6]><link rel="stylesheet" href="/skins/monobook/IE60Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 7]><link rel="stylesheet" href="/skins/monobook/IE70Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<link rel="stylesheet" href="index.php%3Ftitle=MediaWiki:Common.css&amp;usemsgcache=yes&amp;ctype=text%252Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000.css" type="text/css" />
		<link rel="stylesheet" href="index.php%3Ftitle=MediaWiki:Print.css&amp;usemsgcache=yes&amp;ctype=text%252Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000.css" type="text/css" media="print" />
		<link rel="stylesheet" href="index.php%3Ftitle=MediaWiki:Monobook.css&amp;usemsgcache=yes&amp;ctype=text%252Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000.css" type="text/css" />
		<link rel="stylesheet" href="index.php%3Ftitle=-&amp;action=raw&amp;maxage=18000&amp;gen=css.css" type="text/css" />
		<!--[if lt IE 7]><script type="text/javascript" src="/skins/common/IEFixes.js?207"></script>
		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->

		<script type= "text/javascript">/*<![CDATA[*/
		var skin = "monobook";
		var stylepath = "/skins";
		var wgArticlePath = "/index.php/$1";
		var wgScriptPath = "";
		var wgScript = "/index.php";
		var wgVariantArticlePath = false;
		var wgActionPaths = {};
		var wgServer = "http://oar.imag.fr/archive/wiki-oar";
		var wgCanonicalNamespace = "";
		var wgCanonicalSpecialPageName = false;
		var wgNamespaceNumber = 0;
		var wgPageName = "Idhal_virtual_cluster_prototype";
		var wgTitle = "Idhal virtual cluster prototype";
		var wgAction = "edit";
		var wgArticleId = "224";
		var wgIsArticle = false;
		var wgUserName = null;
		var wgUserGroups = null;
		var wgUserLanguage = "en";
		var wgContentLanguage = "en";
		var wgBreakFrames = false;
		var wgCurRevisionId = 2445;
		var wgVersion = "1.15.5-2squeeze6";
		var wgEnableAPI = true;
		var wgEnableWriteAPI = true;
		var wgSeparatorTransformTable = ["", ""];
		var wgDigitTransformTable = ["", ""];
		var wgRestrictionEdit = [];
		var wgRestrictionMove = [];
		/*]]>*/</script>

		<script type="text/javascript" src="skins/common/wikibits.js%3F207"><!-- wikibits js --></script>
		<!-- Head Scripts -->
		<script type="text/javascript" src="http://oar.imag.fr/archive/wiki-oar/skins/common/edit.js?207"></script>
		<script type="text/javascript" src="skins/common/ajax.js%3F207"></script>
		<script type="text/javascript" src="index.php%3Ftitle=-&amp;action=raw&amp;gen=js&amp;useskin=monobook"><!-- site js --></script>
	</head>
<body class="mediawiki ltr ns-0 ns-subject page-Idhal_virtual_cluster_prototype skin-monobook">
	<div id="globalWrapper">
		<div id="column-content">
	<div id="content">
		<a name="top" id="top"></a>
				<h1 id="firstHeading" class="firstHeading">View source</h1>
		<div id="bodyContent">
			<h3 id="siteSub">From WikiOAR</h3>
			<div id="contentSub">for <a href="index.php/Idhal_virtual_cluster_prototype.html" title="Idhal virtual cluster prototype">Idhal virtual cluster prototype</a></div>
									<div id="jump-to-nav">Jump to: <a href="index.php%3Ftitle=Idhal_virtual_cluster_prototype&amp;action=edit.html#column-one">navigation</a>, <a href="index.php%3Ftitle=Idhal_virtual_cluster_prototype&amp;action=edit.html#searchInput">search</a></div>			<!-- start content -->
			<p>You do not have permission to edit this page, for the following reason:
</p>
<div class="permissions-errors">The action you have requested is limited to users in one of the groups: <a href="http://oar.imag.fr/archive/wiki-oar/index.php?title=WikiOAR:Users&amp;action=edit&amp;redlink=1" class="new" title="WikiOAR:Users (page does not exist)">Users</a>, <a href="http://oar.imag.fr/archive/wiki-oar/index.php/WikiOAR:Administrators" title="WikiOAR:Administrators">Administrators</a>, staff.</div>
<p>You can view and copy the source of this page:
</p><textarea id="wpTextbox1" name="wpTextbox1" cols="80" rows="25" readonly="readonly">=Mechanism=
==Secured update procedure==
At the very first boot, a virtual node gets the server GPG public key and never get it again. Then, periodically (at boot and from cron), the virtual node makes an http query to get an update script from the server. The server signs it and the node checks the signature of the script before executing it locally:

[[Image:idhal_updates.png]]
==The update script==
The script looks like:

 UPDATES=&quot;/var/lib/idhal-updates&quot;
 
 # Update #000
 if [ ! -f $UPDATES/000 ]
 then
    #
    # do update 000
    #
    touch $UPDATES/000
 fi
 
 # Update #001
 if [ ! -f $UPDATES/001 ]
 then
    #
    # do update 001
    #
    touch $UPDATES/001
 fi
 
 # and so on...
 
 -----BEGIN PGP SIGNATURE-----
 Version: GnuPG v1.4.6 (GNU/Linux)
 
 iD8DBQFL6V1yWciA6gGguMwRAqU+AJ93IOh+lxAsuYFUUVlrsM6HGorUJACff4ko
 s/bE76z4S4MzZZ1EkN+UyGk=
 =wfbT
 -----END PGP SIGNATURE-----

The key is that an update (a scriptlet) is executed only once.

==The first update sets up the tunnel==
===Update===
 if [ ! -f $UPDATES/000 ]
 then
   wget -q -O /tmp/gen_certif http://129.88.70.253:8080/cgi-bin/gen_certif?idhaltype=vnode || exit 1
   chmod 700 /tmp/gen_certif
   /tmp/gen_certif || exit 1
   rm -f /tmp/gen_certif
   /etc/init.d/openvpn stop
   /etc/init.d/openvpn start
   sleep 10
   touch $UPDATES/000
 fi
=== gen_certif cgi-bin script===
This script generates a unique ID and a certificate for the virtual node. Then, it outputs a bash script that makes an Openvpn configuration and copies the certificate. 

 #!/usr/bin/ruby
 
 require 'fileutils'
 require &quot;cgi&quot;
 cgi = CGI.new
 idhaltype = cgi['idhaltype'] 
 
 EASY_RSA_DIR=&quot;/etc/openvpn/easy-rsa&quot; 
 
 def get_next_id
   id=0
   keys_dir=Dir.new(EASY_RSA_DIR + &quot;/keys&quot;)
   keys_dir.each do |file|
     if client_id=file.scan(/client(\d+)\.crt/)[0]
       if client_id[0].to_i &gt; id
         id=client_id[0].to_i
       end
     end
   end
   return id+1
 end
 
 Dir::chdir(EASY_RSA_DIR) 
 
 id=get_next_id
 system(&quot;. ./vars &gt; /dev/null &amp;&amp; ./pkitool client#{id} &gt; /dev/null 2&gt;&amp;1&quot;)
 f = File.new(&quot;#{EASY_RSA_DIR}/keys/client#{id}.type&quot;,  &quot;w&quot;)
 f.puts idhaltype
 f.close
 
 puts &quot;Content-type: text/plain&quot;
 puts
 puts &quot;#!/bin/bash&quot;
 puts &quot;if [ -d /etc/openvpn ] ; then&quot;
 
 puts &quot;cat &gt; /etc/openvpn/vpns.conf &lt;&lt; EOF
 client
 dev tun
 proto tcp
 remote 129.88.70.253 4242
 ca ca.crt
 cert client.crt
 key client.key
 keepalive 10 60
 cipher none
 up /etc/openvpn/update-resolv-conf
 down /etc/openvpn/update-resolv-conf
 EOF&quot;
 
 puts &quot;cat &gt; /etc/openvpn/client.crt &lt;&lt; EOF&quot;
 IO.foreach(&quot;#{EASY_RSA_DIR}/keys/client#{id}.crt&quot;) { |line| puts line }
 puts &quot;EOF&quot; 
 
 puts &quot;cat &gt; /etc/openvpn/client.key &lt;&lt; EOF&quot;
 IO.foreach(&quot;#{EASY_RSA_DIR}/keys/client#{id}.key&quot;) { |line| puts line }
 puts &quot;EOF&quot; 
 
 puts &quot;chmod 600 /etc/openvpn/client.key&quot; 
 
 puts &quot;fi&quot;

==The VPN server side configuration==
===Openvpn===
 port 4242
 proto tcp
 dev tun0
 ca ca.crt
 cert server.crt
 key server.key
 dh dh1024.pem
 server 10.134.0.0 255.255.0.0
 #ifconfig-pool-persist ipp.txt
 keepalive 10 120
 max-clients 1000
 persist-key
 persist-tun
 status /var/log/openvpn-status.log
 
 # Script where we create/activate OAR nodes
 client-connect /etc/openvpn/client-up.bash
 client-disconnect /etc/openvpn/client-down.bash
 
 # G5K Routes pushing
 push &quot;route 129.88.70.0 255.255.255.192&quot;
 [...]
 
 # DNS pushing
 push &quot;dhcp-option DNS 129.88.70.61&quot;
 push &quot;dhcp-option DNS grenoble.grid5000.fr&quot;
===DNS===
Every virtual ip address is statically declared into DNS like this example:
 vnode-7-38              A       10.134.7.38
==OAR server==
Resources are added automatically when new tunnels come up. Resources are disabled (but not removed) when tunel goes down. This is made inside the client-up/down openvpn scripts:
* /etc/openvpn/client-up.bash:
 #!/bin/bash
 set -e
 
 NODE_NAME=`host -t A $ifconfig_pool_remote_ip |awk -F&quot;: &quot; '{if ($1==&quot;Name&quot;) print $2}'`
 CLIENT_NAME=`host -t A $trusted_ip |awk -F&quot;: &quot; '{if ($1==&quot;Name&quot;) print $2}'`
 NODE=`oarnodes --sql &quot;ip='$ifconfig_pool_remote_ip'&quot;`
 if [ &quot;$NODE&quot; = &quot;&quot; ]
 then
   oarnodesetting -a -h &quot;$NODE_NAME&quot; -p &quot;ip=$ifconfig_pool_remote_ip&quot;
 fi
 
 HIDHAL_TYPE=`cat /etc/openvpn/easy-rsa/keys/$common_name.type 2&gt;/dev/null || true`
 if [ &quot;$HIDHAL_TYPE&quot; != &quot;&quot; ]
 then
   oarnodesetting -p &quot;idhaltype=$HIDHAL_TYPE&quot; \
                  -p &quot;cluster=$HIDHAL_TYPE&quot; -h &quot;$NODE_NAME&quot;
 fi
 
 oarnodesetting -p &quot;idhalcn=$common_name&quot; \
                -p &quot;idhalclientip=$trusted_ip&quot; \
               -p &quot;idhalconnectedsince=`date`&quot; \
               -p &quot;idhalclientname=$CLIENT_NAME&quot; \
               -h $NODE_NAME
 
 echo &quot;/usr/local/sbin/send_root_key.sh $NODE_NAME&quot; | at now + 1 minute
 
 oarnodesetting -s Alive -h &quot;$NODE_NAME&quot;

*  /etc/openvpn/client-down.bash
 #!/bin/bash
 set -e
 
 NODE_NAME=`host -t A $ifconfig_pool_remote_ip |awk -F&quot;: &quot; '{if ($1==&quot;Name&quot;) print $2}'` &gt;&gt; /tmp/down
 
 oarnodesetting -s Absent -h &quot;$NODE_NAME&quot; &gt;&gt; /tmp/down
 
 echo &quot;$NODE_NAME&quot; &gt;&gt; /tmp/down

Here is a sample resource:
 168
        network_address : vnode-2-98.grenoble.grid5000.fr
        properties : besteffort=YES,cluster=vnode,cpuset=0,deploy=NO,desktop_computing=NO,idhalclientip=152.77.57.112,idhalclientname=browalle.ujf-grenoble.fr,idhalcn=client317,idhalconnectedsince=Thu Jul  3 20:32:35 CEST 2008,idhaltype=vnode,ip=10.134.2.98,network_address=vnode-2-98.grenoble.grid5000.fr,type=default
        state : Absent

=Caveats=
The main problem with this solution is that every communication between the nodes is made through the VPN. Actually, we want that the nodes that are on a same LAN or routed network, use their local interface to communicate directly. The solution might be on DNS side...</textarea><div class='templatesUsed'>

</div>
<p>Return to <a href="index.php/Idhal_virtual_cluster_prototype.html" title="Idhal virtual cluster prototype">Idhal virtual cluster prototype</a>.</p>
<div class="printfooter">
Retrieved from "<a href="index.php/Idhal_virtual_cluster_prototype.html">http://oar.imag.fr/archive/wiki-oar/index.php/Idhal_virtual_cluster_prototype</a>"</div>
						<!-- end content -->
						<div class="visualClear"></div>
		</div>
	</div>
		</div>
		<div id="column-one">
	<div id="p-cactions" class="portlet">
		<h5>Views</h5>
		<div class="pBody">
			<ul>
	
				 <li id="ca-nstab-main" class="selected"><a href="index.php/Idhal_virtual_cluster_prototype.html" title="View the content page [c]" accesskey="c">Page</a></li>
				 <li id="ca-talk" class="new"><a href="http://oar.imag.fr/archive/wiki-oar/index.php?title=Talk:Idhal_virtual_cluster_prototype&amp;action=edit&amp;redlink=1" title="Discussion about the content page [t]" accesskey="t">Discussion</a></li>
				 <li id="ca-viewsource" class="selected"><a href="index.php%3Ftitle=Idhal_virtual_cluster_prototype&amp;action=edit.html" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></li>
				 <li id="ca-history"><a href="index.php%3Ftitle=Idhal_virtual_cluster_prototype&amp;action=history.html" title="Past revisions of this page [h]" accesskey="h">History</a></li>			</ul>
		</div>
	</div>
	<div class="portlet" id="p-personal">
		<h5>Personal tools</h5>
		<div class="pBody">
			<ul>
				<li id="pt-login"><a href="index.php%3Ftitle=Special:UserLogin&amp;returnto=Idhal_virtual_cluster_prototype.html" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-logo">
		<a style="background-image: url(http://oar.imag.fr/schemas/oar_logo_small.png);" href="index.html" title="Visit the main page [z]" accesskey="z"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
	<div class='generated-sidebar portlet' id='p-Public_portal'>
		<h5>Public portal</h5>
		<div class='pBody'>
			<ul>
				<li id="n-mainpage"><a href="index.html" title="Visit the main page">Main Page</a></li>
				<li id="n-Appliances-.28Kameleon.29"><a href="index.php/Kameleon.html">Appliances (Kameleon)</a></li>
				<li id="n-OAR-Website"><a href="http://oar.imag.fr">OAR Website</a></li>
				<li id="n-REST-API"><a href="index.php/RESTfullAPI.html">REST API</a></li>
				<li id="n-Customization-tips"><a href="index.php/Configuration_tips.html">Customization tips</a></li>
				<li id="n-OAR.27s-News"><a href="http://oar.imag.fr/news/">OAR's News</a></li>
			</ul>
		</div>
	</div>
	<div class='generated-sidebar portlet' id='p-Summer_of_Code'>
		<h5>Summer of Code</h5>
		<div class='pBody'>
			<ul>
				<li id="n-GSoC-Summary"><a href="index.php/Google_summer_of_code.html">GSoC Summary</a></li>
				<li id="n-2010-edition"><a href="index.php/GSOC_2010.html">2010 edition</a></li>
				<li id="n-2009-edition"><a href="index.php/GSOC_2009.html">2009 edition</a></li>
				<li id="n-2008-edition"><a href="http://oar.imag.fr/works/gsoc/2008/">2008 edition</a></li>
			</ul>
		</div>
	</div>
	<div class='generated-sidebar portlet' id='p-Related_links'>
		<h5>Related links</h5>
		<div class='pBody'>
			<ul>
				<li id="n-Summary"><a href="index.php/Links.html">Summary:</a></li>
				<li id="n-About-OAR-.28French.29"><a href="http://www.projet-plume.org/fr/fiche/oar">About OAR (French)</a></li>
				<li id="n-TakTuk"><a href="http://taktuk.gforge.inria.fr/">TakTuk</a></li>
				<li id="n-CiGri"><a href="http://cigri.imag.fr/">CiGri</a></li>
				<li id="n-Kameleon"><a href="index.php/Kameleon.html">Kameleon</a></li>
				<li id="n-ComputeMode"><a href="http://computemode.imag.fr/">ComputeMode</a></li>
				<li id="n-Xionee"><a href="https://gforge.inria.fr/projects/xionee/">Xionee</a></li>
				<li id="n-KaDeploy"><a href="http://kadeploy.imag.fr/">KaDeploy</a></li>
			</ul>
		</div>
	</div>
	<div class='generated-sidebar portlet' id='p-Developers_portal'>
		<h5>Developers portal</h5>
		<div class='pBody'>
			<ul>
				<li id="n-Summary"><a href="index.php/Developers_Pages.html">Summary:</a></li>
				<li id="n-Meetings-reports"><a href="index.php/Category:Portal:Staff:MeetingReports.html">Meetings reports</a></li>
				<li id="n-Assigned-TaskList"><a href="index.php/Special:TaskList/all.html">Assigned TaskList</a></li>
				<li id="n-Todo-Page"><a href="index.php/TODO.html">Todo Page</a></li>
				<li id="n-Tools-and-Tips"><a href="index.php/Devel_Tools_tips.html">Tools and Tips</a></li>
				<li id="n-FAQ"><a href="index.php/FAQ.html">FAQ</a></li>
			</ul>
		</div>
	</div>
	<div id="p-search" class="portlet">
		<h5><label for="searchInput">Search</label></h5>
		<div id="searchBody" class="pBody">
			<form action="http://oar.imag.fr/archive/wiki-oar/index.php" id="searchform"><div>
				<input type='hidden' name="title" value="Special:Search"/>
				<input id="searchInput" name="search" type="text" title="Search WikiOAR [f]" accesskey="f" value="" />
				<input type='submit' name="go" class="searchButton" id="searchGoButton"	value="Go" title="Go to a page with this exact name if exists" />&nbsp;
				<input type='submit' name="fulltext" class="searchButton" id="mw-searchButton" value="Search" title="Search the pages for this text" />
			</div></form>
		</div>
	</div>
	<div class="portlet" id="p-tb">
		<h5>Toolbox</h5>
		<div class="pBody">
			<ul>
				<li id="t-whatlinkshere"><a href="index.php/Special:WhatLinksHere/Idhal_virtual_cluster_prototype.html" title="List of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
				<li id="t-recentchangeslinked"><a href="index.php/Special:RecentChangesLinked/Idhal_virtual_cluster_prototype.html" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
<li id="t-specialpages"><a href="index.php/Special:SpecialPages.html" title="List of all special pages [q]" accesskey="q">Special pages</a></li>
			</ul>
		</div>
	</div>
		</div><!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>
			<div id="footer">
				<div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>
			<ul id="f-list">
					<li id="about"><a href="index.php/WikiOAR:About.html" title="WikiOAR:About">About WikiOAR and OAR logo</a></li>
			</ul>
		</div>
</div>

		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
<!-- Served in 0.044 secs. --></body></html>
