<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta http-equiv="Content-Style-Type" content="text/css" />
		<meta name="generator" content="MediaWiki 1.15.5-2squeeze6" />
		<meta name="robots" content="noindex,nofollow" />
		<meta name="keywords" content="Job resource manager 2 memory banks.pl,Administrators,Users" />
		<link rel="next" href="index.php/Job_resource_manager_2_memory_banks.pl.html" />
		<link rel="shortcut icon" href="http://oar.imag.fr/images/logo_oar.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="WikiOAR (en)" />
		<link rel="alternate" type="application/rss+xml" title="WikiOAR RSS feed" href="index.php%3Ftitle=Special:RecentChanges&amp;feed=rss" />
		<link rel="alternate" type="application/atom+xml" title="WikiOAR Atom feed" href="index.php%3Ftitle=Special:RecentChanges&amp;feed=atom" />
		<title>View source - WikiOAR</title>
		<link rel="stylesheet" href="skins/common/shared.css%3F207.css" type="text/css" media="screen" />
		<link rel="stylesheet" href="skins/common/commonPrint.css%3F207.css" type="text/css" media="print" />
		<link rel="stylesheet" href="skins/monobook/main.css%3F207.css" type="text/css" media="screen" />
		<!--[if lt IE 5.5000]><link rel="stylesheet" href="/skins/monobook/IE50Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 5.5000]><link rel="stylesheet" href="/skins/monobook/IE55Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 6]><link rel="stylesheet" href="/skins/monobook/IE60Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 7]><link rel="stylesheet" href="/skins/monobook/IE70Fixes.css?207" type="text/css" media="screen" /><![endif]-->
		<link rel="stylesheet" href="index.php%3Ftitle=MediaWiki:Common.css&amp;usemsgcache=yes&amp;ctype=text%252Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000.css" type="text/css" />
		<link rel="stylesheet" href="index.php%3Ftitle=MediaWiki:Print.css&amp;usemsgcache=yes&amp;ctype=text%252Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000.css" type="text/css" media="print" />
		<link rel="stylesheet" href="index.php%3Ftitle=MediaWiki:Monobook.css&amp;usemsgcache=yes&amp;ctype=text%252Fcss&amp;smaxage=18000&amp;action=raw&amp;maxage=18000.css" type="text/css" />
		<link rel="stylesheet" href="index.php%3Ftitle=-&amp;action=raw&amp;maxage=18000&amp;gen=css.css" type="text/css" />
		<!--[if lt IE 7]><script type="text/javascript" src="/skins/common/IEFixes.js?207"></script>
		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->

		<script type= "text/javascript">/*<![CDATA[*/
		var skin = "monobook";
		var stylepath = "/skins";
		var wgArticlePath = "/index.php/$1";
		var wgScriptPath = "";
		var wgScript = "/index.php";
		var wgVariantArticlePath = false;
		var wgActionPaths = {};
		var wgServer = "http://oar.imag.fr/archive/wiki-oar";
		var wgCanonicalNamespace = "";
		var wgCanonicalSpecialPageName = false;
		var wgNamespaceNumber = 0;
		var wgPageName = "Job_resource_manager_2_memory_banks.pl";
		var wgTitle = "Job resource manager 2 memory banks.pl";
		var wgAction = "edit";
		var wgArticleId = "115";
		var wgIsArticle = false;
		var wgUserName = null;
		var wgUserGroups = null;
		var wgUserLanguage = "en";
		var wgContentLanguage = "en";
		var wgBreakFrames = false;
		var wgCurRevisionId = 1141;
		var wgVersion = "1.15.5-2squeeze6";
		var wgEnableAPI = true;
		var wgEnableWriteAPI = true;
		var wgSeparatorTransformTable = ["", ""];
		var wgDigitTransformTable = ["", ""];
		var wgRestrictionEdit = [];
		var wgRestrictionMove = [];
		/*]]>*/</script>

		<script type="text/javascript" src="skins/common/wikibits.js%3F207"><!-- wikibits js --></script>
		<!-- Head Scripts -->
		<script type="text/javascript" src="http://oar.imag.fr/archive/wiki-oar/skins/common/edit.js?207"></script>
		<script type="text/javascript" src="skins/common/ajax.js%3F207"></script>
		<script type="text/javascript" src="index.php%3Ftitle=-&amp;action=raw&amp;gen=js&amp;useskin=monobook"><!-- site js --></script>
	</head>
<body class="mediawiki ltr ns-0 ns-subject page-Job_resource_manager_2_memory_banks_pl skin-monobook">
	<div id="globalWrapper">
		<div id="column-content">
	<div id="content">
		<a name="top" id="top"></a>
				<h1 id="firstHeading" class="firstHeading">View source</h1>
		<div id="bodyContent">
			<h3 id="siteSub">From WikiOAR</h3>
			<div id="contentSub">for <a href="index.php/Job_resource_manager_2_memory_banks.pl.html" title="Job resource manager 2 memory banks.pl">Job resource manager 2 memory banks.pl</a></div>
									<div id="jump-to-nav">Jump to: <a href="index.php%3Ftitle=Job_resource_manager_2_memory_banks.pl&amp;action=edit.html#column-one">navigation</a>, <a href="index.php%3Ftitle=Job_resource_manager_2_memory_banks.pl&amp;action=edit.html#searchInput">search</a></div>			<!-- start content -->
			<p>You do not have permission to edit this page, for the following reason:
</p>
<div class="permissions-errors">The action you have requested is limited to users in one of the groups: <a href="http://oar.imag.fr/archive/wiki-oar/index.php?title=WikiOAR:Users&amp;action=edit&amp;redlink=1" class="new" title="WikiOAR:Users (page does not exist)">Users</a>, <a href="http://oar.imag.fr/archive/wiki-oar/index.php/WikiOAR:Administrators" title="WikiOAR:Administrators">Administrators</a>, staff.</div>
<p>You can view and copy the source of this page:
</p><textarea id="wpTextbox1" name="wpTextbox1" cols="80" rows="25" readonly="readonly"> # $Id: job_resource_manager.pl 1648 2008-09-17 16:00:56Z neyron $                            
 #                                                                                            
 # The job_resource_manager script is a perl script that oar server deploys on nodes          
 # to manage cpusets, users, job keys, ...                                                    
 #                                                                                            
 # Usage:                                                                                     
 # This script is deployed from the server and executed as oar on the nodes                   
 # ARGV[0] can have two different values:                                                     
 #     - &quot;init&quot;  : then this script must create the right cpuset and assign                   
 #                 corresponding cpus                                                         
 #     - &quot;clean&quot; : then this script must kill all processes in the cpuset and                 
 #                 clean the cpuset structure                                                 
                                                                                              
 # TAKTUK_HOSTNAME environment variable must be defined and must be a name                    
 # that we will be able to find in the transfered hashtable ($Cpuset variable).               
 use Fcntl ':flock';                                                                          
 #use Data::Dumper;                                                                           
                                                                                              
 sub exit_myself($$);                                                                         
 sub print_log($$);                                                                           
                                                                                              
 my $Old_umask = sprintf(&quot;%lo&quot;,umask());                                                      
 umask(oct(&quot;022&quot;));                                                                           
                                                                                              
 my $Cpuset;                                                                                  
 my $Log_level;                                                                               
                                                                                              
 # Retrieve parameters from STDIN in the &quot;Cpuset&quot; structure which looks like:                 
 # $Cpuset = {                                                                                
 #               job_id =&gt; id of the corresponding job                                        
 #               name =&gt; &quot;cpuset name&quot;,                                                       
 #               cpuset_path =&gt; &quot;relative path in the cpuset FS&quot;,                             
 #               nodes =&gt; hostname =&gt; [array with the content of the database cpuset field]   
 #               ssh_keys =&gt; {                                                                
 #                               public =&gt; {                                                  
 #                                           file_name =&gt; &quot;~oar/.ssh/authorized_keys&quot;         
 #                                           key =&gt; &quot;public key content&quot;                      
 #                                         }                                                  
 #                               private =&gt; {                                                 
 #                                           file_name =&gt; &quot;directory where to store the private key&quot;                                                                                          
 #                                           key =&gt; &quot;private key content&quot;                      
 #                                          }                                                  
 #                           }                                                                 
 #               oar_tmp_directory =&gt; &quot;path to the temp directory&quot;                             
 #               user =&gt; &quot;user name&quot;                                                           
 #               job_user =&gt; &quot;job user&quot;                                                        
 #               job_uid =&gt; &quot;job uid for the job_user if needed&quot;                               
 #               types =&gt; hashtable with job types as keys                                     
 #               log_level =&gt; debug level number                                               
 #           }                                                                                 
 my $tmp = &quot;&quot;;                                                                                 
 while (&lt;STDIN&gt;){                                                                              
     $tmp .= $_;                                                                               
 }                                                                                             
 $Cpuset = eval($tmp);                                                                         
                                                                                               
 if (!defined($Cpuset-&gt;{log_level})){                                                          
     exit_myself(2,&quot;Bad SSH hashtable transfered&quot;);                                            
 }                                                                                             
 $Log_level = $Cpuset-&gt;{log_level};                                                            
 my $Cpuset_path_job;                                                                          
 my @Cpuset_cpus;                                                                              
 # Get the data structure only for this node                                                   
 if (defined($Cpuset-&gt;{cpuset_path})){                                                         
     $Cpuset_path_job = $Cpuset-&gt;{cpuset_path}.'/'.$Cpuset-&gt;{name};                            
     @Cpuset_cpus = @{$Cpuset-&gt;{nodes}-&gt;{$ENV{TAKTUK_HOSTNAME}}};                              
 }                                                                                             
                                                                                               
                                                                                               
                                                                                               
 print_log(3,&quot;$ARGV[0]&quot;);                                                                      
 if ($ARGV[0] eq &quot;init&quot;){                                                                      
     # Initialize cpuset for this node                                                         
     # First, create the tmp oar directory                                                     
     if (!(((-d $Cpuset-&gt;{oar_tmp_directory}) and (-O $Cpuset-&gt;{oar_tmp_directory})) or (mkdir($Cpuset-&gt;{oar_tmp_directory})))){                                                              
         exit_myself(13,&quot;Directory $Cpuset-&gt;{oar_tmp_directory} does not exist and cannot be created&quot;);                                                                                       
     }                                                                                         
                                                                                               
     if (defined($Cpuset-&gt;{job_uid})){                                                         
         my $prevuser = getpwuid($Cpuset-&gt;{job_uid});                                          
         system(&quot;oardodo /usr/sbin/userdel -f $prevuser&quot;) if (defined($prevuser));             
         my @tmp = getpwnam($Cpuset-&gt;{user});                                                  
         if ($#tmp &lt; 0){                                                                       
             exit_myself(15,&quot;Cannot get information from user '$Cpuset-&gt;{user}'&quot;);             
         }                                                                                     
         if (system(&quot;oardodo /usr/sbin/adduser --disabled-password --gecos 'OAR temporary user' --no-create-home --force-badname --quiet --home $tmp[7] --gid $tmp[3] --shell $tmp[8] --uid $Cpuset-&gt;{job_uid} $Cpuset-&gt;{job_user}&quot;)){                                                       
             exit_myself(15,&quot;Failed to create $Cpuset-&gt;{job_user} with uid $Cpuset-&gt;{job_uid} and home $tmp[7] and group $tmp[3] and shell $tmp[8]&quot;);                                         
         }                                                                                     
     }                                                                                         
                                                                                               
     if (defined($Cpuset_path_job)){                                                           
         if (open(LOCKFILE,&quot;&gt; $Cpuset-&gt;{oar_tmp_directory}/job_manager_lock_file&quot;)){           
             flock(LOCKFILE,LOCK_EX) or exit_myself(17,&quot;flock failed: $!&quot;);                    
             if (system('oardodo mount -t cpuset | grep &quot; /dev/cpuset &quot; &gt; /dev/null 2&gt;&amp;1')){   
                 if (system('oardodo mkdir -p /dev/cpuset &amp;&amp; oardodo mount -t cpuset none /dev/cpuset')){                                                                                     
                     exit_myself(4,&quot;Failed to mount cpuset pseudo filesystem&quot;);                
                 }                                                                             
             }                                                                                 
             if (!(-d '/dev/cpuset/'.$Cpuset-&gt;{cpuset_path})){                                 
                 if (system( 'oardodo mkdir -p /dev/cpuset/'.$Cpuset-&gt;{cpuset_path}.' &amp;&amp;'.     
                             'oardodo chown -R oar /dev/cpuset/'.$Cpuset-&gt;{cpuset_path}.' &amp;&amp;'. 
                             '/bin/echo 0 | cat &gt; /dev/cpuset/'.$Cpuset-&gt;{cpuset_path}.'/notify_on_release &amp;&amp; '.                                                                              
                             '/bin/echo 0 | cat &gt; /dev/cpuset/'.$Cpuset-&gt;{cpuset_path}.'/cpu_exclusive &amp;&amp; '.                                                                                  
                             'cat /dev/cpuset/mems &gt; /dev/cpuset/'.$Cpuset-&gt;{cpuset_path}.'/mems &amp;&amp;'.                                                                                         
                             'cat /dev/cpuset/cpus &gt; /dev/cpuset/'.$Cpuset-&gt;{cpuset_path}.'/cpus'                                                                                             
                         )){                                                                   
                     exit_myself(4,&quot;Failed to create cpuset $Cpuset-&gt;{cpuset_path}&quot;);          
                 }                                                                             
             }                                                                                 
             flock(LOCKFILE,LOCK_UN) or exit_myself(17,&quot;flock failed: $!&quot;);                    
             close(LOCKFILE);                                                                  
         }else{                                                                                
             exit_myself(16,&quot;Failed to open or create $Cpuset-&gt;{oar_tmp_directory}/job_manager_lock_file&quot;);                                                                                   
         }                                                                                     
                                                                                               
        '''my $mem = &quot;&quot;;  '''                                                                        
        '''my $c = 0;      '''                                                                       
        '''while (($c &lt;= $#Cpuset_cpus)){ '''                                                        
                ''' my $core_id=$Cpuset_cpus[$c];   '''                                              
                ''' my $physical_id=`cat /sys/devices/system/cpu/cpu$core_id/topology/physical_package_id`;  '''                                                                                    
              '''  chomp($physical_id); '''                                                   
              '''  if ($physical_id == 1){   '''                                                     
              '''  if (($mem eq &quot;&quot;) or ($mem eq &quot;1&quot;)){   '''                                 
                             '''   $mem = &quot;1&quot;;     '''                                               
                      '''  }else{       '''                                                          
                             '''   $mem = &quot;0,1&quot;;  '''                                                
                   '''     }    '''                                                                  
              '''  }else{  '''                                                                       
                     '''   if (($mem eq &quot;&quot;) or ($mem eq &quot;0&quot;)){  '''                                  
                              '''  $mem = &quot;0&quot;;  '''                                                  
                      '''  }else{  '''                                                               
                             '''   $mem = &quot;0,1&quot;;   '''                                               
                      '''  }     '''                                                                 
             '''   }  '''                                                                            
             '''   $c++;   '''                                                                       
        }'''                                                                                      
                                                                                               
                                                                                               
                                                                                               
 #'for c in '.&quot;@Cpuset_cpus&quot;.';do cat /sys/devices/system/cpu/cpu$c/topology/physical_package_id &gt; /dev/cpuset/'.$Cpuset_path_job.'/mems; done &amp;&amp; '.                                          
                                                                                               
 # Be careful with the physical_package_id. Is it corresponding to the memory banc?            
         if (system( 'oardodo mkdir -p /dev/cpuset/'.$Cpuset_path_job.' &amp;&amp; '.                  
                     'oardodo chown -R oar /dev/cpuset/'.$Cpuset_path_job.' &amp;&amp; '.              
                     '/bin/echo 0 | cat &gt; /dev/cpuset/'.$Cpuset_path_job.'/notify_on_release &amp;&amp; '.                                                                                            
                     '/bin/echo 0 | cat &gt; /dev/cpuset/'.$Cpuset_path_job.'/cpu_exclusive &amp;&amp; '. 
                 '''    '/bin/echo '.$mem.' | cat &gt; /dev/cpuset/'.$Cpuset_path_job.'/mems &amp;&amp; '.  ''' 
                     '/bin/echo '.join(&quot;,&quot;,@Cpuset_cpus).' | cat &gt; /dev/cpuset/'.$Cpuset_path_job.'/cpus'                                                                                     
                   )){                                                                         
             exit_myself(5,&quot;Failed to create and feed the cpuset $Cpuset_path_job&quot;);           
         }                                                                                     
     }                                                                                         
                                                                                               
     # Copy ssh key files                                                                      
     if ($Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{key} ne &quot;&quot;){                                         
         # private key                                                                         
         if (open(PRIV, &quot;&gt;&quot;.$Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{file_name})){                     
             chmod(0600,$Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{file_name});                          
             if (!print(PRIV $Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{key})){                          
                 unlink($Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{file_name});                          
                 exit_myself(8,&quot;Error writing $Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{file_name}&quot;);   
             }                                                                                 
             close(PRIV);                                                                      
             if (defined($Cpuset-&gt;{job_uid})){                                                 
                 system(&quot;ln -s $Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{file_name} $Cpuset-&gt;{oar_tmp_directory}/$Cpuset-&gt;{job_user}.jobkey&quot;);                                                         
             }                                                                                 
         }else{                                                                                
             exit_myself(7,&quot;Error opening $Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{file_name}&quot;);       
         }                                                                                     
                                                                                               
         # public key                                                                          
         if (open(PUB,&quot;+&lt;&quot;,$Cpuset-&gt;{ssh_keys}-&gt;{public}-&gt;{file_name})){                       
             flock(PUB,LOCK_EX) or exit_myself(17,&quot;flock failed: $!&quot;);                         
             seek(PUB,0,0) or exit_myself(18,&quot;seek failed: $!&quot;);                               
             my $out = &quot;\n&quot;.$Cpuset-&gt;{ssh_keys}-&gt;{public}-&gt;{key}.&quot;\n&quot;;                         
             while (&lt;PUB&gt;){                                                                    
                 if ($_ =~ /environment=\&quot;OAR_KEY=1\&quot;/){                                       
                     # We are reading a OAR key                                                
                     $_ =~ /(ssh-dss|ssh-rsa)\s+([^\s^\n]+)/;                                  
                     my $oar_key = $2;                                                         
                     $Cpuset-&gt;{ssh_keys}-&gt;{public}-&gt;{key} =~ /(ssh-dss|ssh-rsa)\s+([^\s^\n]+)/;
                     my $curr_key = $2;                                                        
                     if ($curr_key eq $oar_key){                                               
                         exit_myself(13,&quot;ERROR: the user has specified the same ssh key than used by the user oar&quot;);                                                                          
                     }                                                                         
                     $out .= $_;                                                               
                 }elsif ($_ =~ /environment=\&quot;OAR_CPUSET=([\w\/]+)\&quot;/){                        
                     # Remove from authorized keys outdated keys (typically after a reboot)    
                     if (-d &quot;/dev/cpuset/$1&quot;){                                                 
                         $out .= $_;                                                           
                     }                                                                         
                 }else{                                                                        
                     $out .= $_;                                                               
                 }                                                                             
             }                                                                                 
             if (!(seek(PUB,0,0) and print(PUB $out) and truncate(PUB,tell(PUB)))){            
                 exit_myself(9,&quot;Error writing $Cpuset-&gt;{ssh_keys}-&gt;{public}-&gt;{file_name}&quot;);    
             }                                                                                 
             flock(PUB,LOCK_UN) or exit_myself(17,&quot;flock failed: $!&quot;);                         
             close(PUB);                                                                       
         }else{                                                                                
             unlink($Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{file_name});                              
             exit_myself(10,&quot;Error opening $Cpuset-&gt;{ssh_keys}-&gt;{public}-&gt;{file_name}&quot;);       
         }                                                                                     
     }                                                                                         
 }elsif ($ARGV[0] eq &quot;clean&quot;){                                                                 
     # delete ssh key files                                                                    
     if ($Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{key} ne &quot;&quot;){                                         
         # private key                                                                         
         unlink($Cpuset-&gt;{ssh_keys}-&gt;{private}-&gt;{file_name});                                  
         if (defined($Cpuset-&gt;{job_uid})){                                                     
             unlink(&quot;$Cpuset-&gt;{oar_tmp_directory}/$Cpuset-&gt;{job_user}.jobkey&quot;);                
         }                                                                                     
                                                                                               
         # public key                                                                          
         if (open(PUB,&quot;+&lt;&quot;, $Cpuset-&gt;{ssh_keys}-&gt;{public}-&gt;{file_name})){                      
             flock(PUB,LOCK_EX) or exit_myself(17,&quot;flock failed: $!&quot;);                         
             seek(PUB,0,0) or exit_myself(18,&quot;seek failed: $!&quot;);                               
             #Change file on the fly                                                           
             my $out = &quot;&quot;;                                                                     
             while (&lt;PUB&gt;){                                                                    
                 if (($_ ne &quot;\n&quot;) and ($_ ne $Cpuset-&gt;{ssh_keys}-&gt;{public}-&gt;{key})){           
                     $out .= $_;                                                               
                 }                                                                             
             }                                                                                 
             if (!(seek(PUB,0,0) and print(PUB $out) and truncate(PUB,tell(PUB)))){            
                 exit_myself(12,&quot;Error changing $Cpuset-&gt;{ssh_keys}-&gt;{public}-&gt;{file_name}&quot;);  
             }                                                                                 
             flock(PUB,LOCK_UN) or exit_myself(17,&quot;flock failed: $!&quot;);                         
             close(PUB);                                                                       
         }else{                                                                                
             exit_myself(11,&quot;Error opening $Cpuset-&gt;{ssh_keys}-&gt;{public}-&gt;{file_name}&quot;);       
         }                                                                                     
     }                                                                                         
                                                                                               
     # Clean cpuset on this node                                                               
     if (defined($Cpuset_path_job)){                                                           
         system('PROCESSES=$(cat /dev/cpuset/'.$Cpuset_path_job.'/tasks)                       
                 while [ &quot;$PROCESSES&quot; != &quot;&quot; ]                                                  
                 do                                                                            
                     oardodo kill -9 $PROCESSES                                                
                     PROCESSES=$(cat /dev/cpuset/'.$Cpuset_path_job.'/tasks)                   
                 done'                                                                         
               );                                                                              
                                                                                               
         if (system('oardodo rmdir /dev/cpuset'.$Cpuset_path_job)){                            
             # Uncomment this line if you want to use several network_address properties       
             # which are the same physical computer (linux kernel)                             
             #exit(0);                                                                         
             exit_myself(6,&quot;Failed to delete the cpuset $Cpuset_path_job&quot;);                    
         }                                                                                     
     }                                                                                         
     if (defined($Cpuset-&gt;{job_uid})){                                                         
         my $ipcrm_args=&quot;&quot;;                                                                    
         if (open(IPCMSG,&quot;&lt; /proc/sysvipc/msg&quot;)) {                                             
             &lt;IPCMSG&gt;;                                                                         
             while (&lt;IPCMSG&gt;) {                                                                
                 if (/\s+\d+\s+(\d+)(?:\s+\d+){5}\s+$Cpuset-&gt;{job_uid}(?:\s+\d+){6}$/) {       
                     $ipcrm_args .= &quot; -q $1&quot;;                                                  
                 }                                                                             
             }                                                                                 
             close (IPCMSG);                                                                   
         }else{                                                                                
             exit_myself(14,&quot;Cannot open /proc/sysvipc/msg: $!&quot;);                              
         }                                                                                     
         if (open(IPCSHM,&quot;&lt; /proc/sysvipc/shm&quot;)) {                                             
             &lt;IPCSHM&gt;;                                                                         
             while (&lt;IPCSHM&gt;) {                                                                
                 if (/\s+\d+\s+(\d+)(?:\s+\d+){5}\s+$Cpuset-&gt;{job_uid}(?:\s+\d+){6}$/) {       
                     $ipcrm_args .= &quot; -m $1&quot;;                                                  
                 }                                                                             
             }                                                                                 
             close (IPCSHM);                                                                   
         }else{                                                                                
             exit_myself(14,&quot;Cannot open /proc/sysvipc/shm: $!&quot;);                              
         }                                                                                     
         if (open(IPCSEM,&quot;&lt; /proc/sysvipc/sem&quot;)) {                                             
             &lt;IPCSEM&gt;;                                                                         
             while (&lt;IPCSEM&gt;) {                                                                
                 if (/\s+\d+\s+(\d+)(?:\s+\d+){2}\s+$Cpuset-&gt;{job_uid}(?:\s+\d+){5}$/) {       
                     $ipcrm_args .= &quot; -s $1&quot;;                                                  
                 }
             }
             close (IPCSEM);
         }else{
             exit_myself(14,&quot;Cannot open /proc/sysvipc/sem: $!&quot;);
         }
         if ($ipcrm_args) {
             print_log(3,&quot;Purging SysV IPC: ipcrm $ipcrm_args&quot;);
             if(system(&quot;oardodo ipcrm $ipcrm_args&quot;)){
                 exit_myself(14,&quot;Failed to purge IPC: ipcrm $ipcrm_args&quot;);
             }
         }
         print_log(3,&quot;Purging /tmp...&quot;);
         #system(&quot;oardodo find /tmp/ -user $Cpuset-&gt;{job_user} -exec rm -rfv {} \\;&quot;);
         system(&quot;oardodo find /tmp/. -user $Cpuset-&gt;{job_user} -delete&quot;);
         system(&quot;oardodo /usr/sbin/userdel -f $Cpuset-&gt;{job_user}&quot;);
     }
 }else{
     exit_myself(3,&quot;Bad command line argument $ARGV[0]&quot;);
 }
 
 exit(0);
 
 # Print error message and exit
 sub exit_myself($$){
     my $exit_code = shift;
     my $str = shift;
 
     warn(&quot;[job_resource_manager][$Cpuset-&gt;{job_id}][ERROR] &quot;.$str.&quot;\n&quot;);
     exit($exit_code);
 }
 
 # Print log message depending on the LOG_LEVEL config value
 sub print_log($$){
     my $l = shift;
     my $str = shift;
 
     if ($l &lt;= $Log_level){
         print(&quot;[job_resource_manager][$Cpuset-&gt;{job_id}][DEBUG] $str\n&quot;);
     }
 }</textarea><div class='templatesUsed'>

</div>
<p>Return to <a href="index.php/Job_resource_manager_2_memory_banks.pl.html" title="Job resource manager 2 memory banks.pl">Job resource manager 2 memory banks.pl</a>.</p>
<div class="printfooter">
Retrieved from "<a href="index.php/Job_resource_manager_2_memory_banks.pl.html">http://oar.imag.fr/archive/wiki-oar/index.php/Job_resource_manager_2_memory_banks.pl</a>"</div>
						<!-- end content -->
						<div class="visualClear"></div>
		</div>
	</div>
		</div>
		<div id="column-one">
	<div id="p-cactions" class="portlet">
		<h5>Views</h5>
		<div class="pBody">
			<ul>
	
				 <li id="ca-nstab-main" class="selected"><a href="index.php/Job_resource_manager_2_memory_banks.pl.html" title="View the content page [c]" accesskey="c">Page</a></li>
				 <li id="ca-talk" class="new"><a href="http://oar.imag.fr/archive/wiki-oar/index.php?title=Talk:Job_resource_manager_2_memory_banks.pl&amp;action=edit&amp;redlink=1" title="Discussion about the content page [t]" accesskey="t">Discussion</a></li>
				 <li id="ca-viewsource" class="selected"><a href="index.php%3Ftitle=Job_resource_manager_2_memory_banks.pl&amp;action=edit.html" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></li>
				 <li id="ca-history"><a href="index.php%3Ftitle=Job_resource_manager_2_memory_banks.pl&amp;action=history.html" title="Past revisions of this page [h]" accesskey="h">History</a></li>			</ul>
		</div>
	</div>
	<div class="portlet" id="p-personal">
		<h5>Personal tools</h5>
		<div class="pBody">
			<ul>
				<li id="pt-login"><a href="index.php%3Ftitle=Special:UserLogin&amp;returnto=Job_resource_manager_2_memory_banks.pl.html" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-logo">
		<a style="background-image: url(http://oar.imag.fr/schemas/oar_logo_small.png);" href="index.html" title="Visit the main page [z]" accesskey="z"></a>
	</div>
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
	<div class='generated-sidebar portlet' id='p-Public_portal'>
		<h5>Public portal</h5>
		<div class='pBody'>
			<ul>
				<li id="n-mainpage"><a href="index.html" title="Visit the main page">Main Page</a></li>
				<li id="n-Appliances-.28Kameleon.29"><a href="index.php/Kameleon.html">Appliances (Kameleon)</a></li>
				<li id="n-OAR-Website"><a href="http://oar.imag.fr">OAR Website</a></li>
				<li id="n-REST-API"><a href="index.php/RESTfullAPI.html">REST API</a></li>
				<li id="n-Customization-tips"><a href="index.php/Configuration_tips.html">Customization tips</a></li>
				<li id="n-OAR.27s-News"><a href="http://oar.imag.fr/news/">OAR's News</a></li>
			</ul>
		</div>
	</div>
	<div class='generated-sidebar portlet' id='p-Summer_of_Code'>
		<h5>Summer of Code</h5>
		<div class='pBody'>
			<ul>
				<li id="n-GSoC-Summary"><a href="index.php/Google_summer_of_code.html">GSoC Summary</a></li>
				<li id="n-2010-edition"><a href="index.php/GSOC_2010.html">2010 edition</a></li>
				<li id="n-2009-edition"><a href="index.php/GSOC_2009.html">2009 edition</a></li>
				<li id="n-2008-edition"><a href="http://oar.imag.fr/works/gsoc/2008/">2008 edition</a></li>
			</ul>
		</div>
	</div>
	<div class='generated-sidebar portlet' id='p-Related_links'>
		<h5>Related links</h5>
		<div class='pBody'>
			<ul>
				<li id="n-Summary"><a href="index.php/Links.html">Summary:</a></li>
				<li id="n-About-OAR-.28French.29"><a href="http://www.projet-plume.org/fr/fiche/oar">About OAR (French)</a></li>
				<li id="n-TakTuk"><a href="http://taktuk.gforge.inria.fr/">TakTuk</a></li>
				<li id="n-CiGri"><a href="http://cigri.imag.fr/">CiGri</a></li>
				<li id="n-Kameleon"><a href="index.php/Kameleon.html">Kameleon</a></li>
				<li id="n-ComputeMode"><a href="http://computemode.imag.fr/">ComputeMode</a></li>
				<li id="n-Xionee"><a href="https://gforge.inria.fr/projects/xionee/">Xionee</a></li>
				<li id="n-KaDeploy"><a href="http://kadeploy.imag.fr/">KaDeploy</a></li>
			</ul>
		</div>
	</div>
	<div class='generated-sidebar portlet' id='p-Developers_portal'>
		<h5>Developers portal</h5>
		<div class='pBody'>
			<ul>
				<li id="n-Summary"><a href="index.php/Developers_Pages.html">Summary:</a></li>
				<li id="n-Meetings-reports"><a href="index.php/Category:Portal:Staff:MeetingReports.html">Meetings reports</a></li>
				<li id="n-Assigned-TaskList"><a href="index.php/Special:TaskList/all.html">Assigned TaskList</a></li>
				<li id="n-Todo-Page"><a href="index.php/TODO.html">Todo Page</a></li>
				<li id="n-Tools-and-Tips"><a href="index.php/Devel_Tools_tips.html">Tools and Tips</a></li>
				<li id="n-FAQ"><a href="index.php/FAQ.html">FAQ</a></li>
			</ul>
		</div>
	</div>
	<div id="p-search" class="portlet">
		<h5><label for="searchInput">Search</label></h5>
		<div id="searchBody" class="pBody">
			<form action="http://oar.imag.fr/archive/wiki-oar/index.php" id="searchform"><div>
				<input type='hidden' name="title" value="Special:Search"/>
				<input id="searchInput" name="search" type="text" title="Search WikiOAR [f]" accesskey="f" value="" />
				<input type='submit' name="go" class="searchButton" id="searchGoButton"	value="Go" title="Go to a page with this exact name if exists" />&nbsp;
				<input type='submit' name="fulltext" class="searchButton" id="mw-searchButton" value="Search" title="Search the pages for this text" />
			</div></form>
		</div>
	</div>
	<div class="portlet" id="p-tb">
		<h5>Toolbox</h5>
		<div class="pBody">
			<ul>
				<li id="t-whatlinkshere"><a href="index.php/Special:WhatLinksHere/Job_resource_manager_2_memory_banks.pl.html" title="List of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
				<li id="t-recentchangeslinked"><a href="index.php/Special:RecentChangesLinked/Job_resource_manager_2_memory_banks.pl.html" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
<li id="t-specialpages"><a href="index.php/Special:SpecialPages.html" title="List of all special pages [q]" accesskey="q">Special pages</a></li>
			</ul>
		</div>
	</div>
		</div><!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>
			<div id="footer">
				<div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" /></a></div>
			<ul id="f-list">
					<li id="about"><a href="index.php/WikiOAR:About.html" title="WikiOAR:About">About WikiOAR and OAR logo</a></li>
			</ul>
		</div>
</div>

		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
<!-- Served in 0.044 secs. --></body></html>
